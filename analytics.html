<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AF Meter ‚Äî Analytics</title>
  <link rel="stylesheet" href="assets/styles.css">
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      text-align: center;
      padding: 16px;
    }
    .stat-label {
      font-size: 0.85em;
      opacity: 0.7;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #64ffda;
      margin-bottom: 4px;
    }
    .stat-unit {
      font-size: 0.9em;
      opacity: 0.6;
    }
    #refresh-icon {
      display: inline-block;
      transition: transform 0.3s;
    }
    #refresh-icon.spinning {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    #data-table tbody tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .control-group {
      flex: 1;
      min-width: 200px;
    }
    .control-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9em;
      opacity: 0.8;
    }
    .control-group select,
    .control-group input {
      width: 100%;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: inherit;
    }
    .custom-range-panel {
      display: none;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .date-inputs {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .date-inputs > div {
      flex: 1;
      min-width: 150px;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .loading-state,
    .empty-state {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .loading-state .icon {
      font-size: 2em;
      margin-bottom: 8px;
    }
    .empty-state .icon {
      font-size: 3em;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    .data-table-container {
      overflow-x: auto;
    }
    #data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    #data-table thead tr {
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    #data-table th,
    #data-table td {
      padding: 8px;
    }
    #data-table th {
      text-align: left;
    }
    #data-table td:not(:first-child) {
      text-align: right;
    }
    details summary {
      cursor: pointer;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      user-select: none;
    }
    details summary:hover {
      background: rgba(255,255,255,0.08);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="gradient-card glow-primary">
      <h1>AF Meter</h1>
      <nav class="links">
        <a href="index.html"><button class="ghost">Home</button></a>
        <a href="connect.html"><button class="ghost">Connect</button></a>
        <a href="analytics.html"><button>Analytics</button></a>
        <a href="multi-device.html"><button class="ghost">Devices</button></a>
        <a href="settings.html"><button class="ghost">Settings</button></a>
      </nav>
    </header>
    <main>
      <section class="page">
        <h2>Analytics Dashboard</h2>
        
        <!-- Stats Overview Cards -->
        <div class="stats-grid">
          <div class="card stat-card">
            <div class="stat-label">Total Energy</div>
            <div class="stat-value" id="stat-total">--</div>
            <div class="stat-unit">kWh</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Average Power</div>
            <div class="stat-value" id="stat-avg">--</div>
            <div class="stat-unit">kW</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Peak Power</div>
            <div class="stat-value" id="stat-peak">--</div>
            <div class="stat-unit">kW</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Readings</div>
            <div class="stat-value" id="stat-count">--</div>
            <div class="stat-unit">samples</div>
          </div>
        </div>

        <!-- Chart Controls -->
        <div class="card animate-pulse-glow">
          <div class="control-row">
            <div class="control-group">
              <label for="time-range">Time Range:</label>
              <select id="time-range">
                <option value="all">All Data</option>
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            
            <div class="control-group">
              <label for="chart-type">Chart Type:</label>
              <select id="chart-type">
                <option value="line">Line Chart</option>
                <option value="bar">Bar Chart</option>
                <option value="area">Area Chart</option>
              </select>
            </div>

            <div class="control-group" style="display: flex; align-items: flex-end;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; margin-bottom: 0;">
                <input type="checkbox" id="auto-refresh" style="cursor: pointer;">
                <span style="font-size: 0.9em;">Auto-refresh (30s)</span>
              </label>
            </div>
          </div>

          <!-- Custom Date Range -->
          <div id="custom-range" class="custom-range-panel">
            <div class="date-inputs">
              <div>
                <label>From:</label>
                <input type="datetime-local" id="date-from">
              </div>
              <div>
                <label>To:</label>
                <input type="datetime-local" id="date-to">
              </div>
              <div style="display: flex; align-items: flex-end;">
                <button id="btn-apply-range">Apply</button>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button id="btn-refresh">
              <span id="refresh-icon">üîÑ</span> Load Data
            </button>
            <button id="btn-clear" class="ghost">Clear Data</button>
            <button id="btn-download" class="ghost">üì• Download CSV</button>
            <button id="btn-download-json" class="ghost">üìÑ Download JSON</button>
            <button id="btn-compare" class="ghost">üìä Compare Periods</button>
          </div>

          <!-- Loading State -->
          <div id="loading-state" class="loading-state">
            <div class="icon">‚è≥</div>
            <p>Loading data...</p>
          </div>

          <!-- Empty State -->
          <div id="empty-state" class="empty-state">
            <div class="icon">üìä</div>
            <p class="status">No data available. Visit the <a href="connect.html" style="color: #64ffda; text-decoration: underline;">Connect page</a> to fetch or simulate data.</p>
          </div>

          <!-- Chart Container -->
          <div id="chart-container" style="position: relative;">
            <canvas id="chart"></canvas>
          </div>

          <!-- Summary Stats -->
          <div style="margin-top: 16px;" id="summary" class="status"></div>
        </div>

        <!-- Data Table -->
        <details style="margin-top: 20px;">
          <summary>
            <strong>üìã View Raw Data Table</strong>
          </summary>
          <div class="card data-table-container" style="margin-top: 12px;">
            <table id="data-table">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Energy (kWh)</th>
                  <th>Power (kW)</th>
                  <th>Voltage (V)</th>
                  <th>Current (A)</th>
                </tr>
              </thead>
              <tbody id="table-body">
                <tr>
                  <td colspan="5" style="padding: 20px; text-align: center; opacity: 0.6;">No data loaded</td>
                </tr>
              </tbody>
            </table>
          </div>
        </details>
      </section>
    </main>
    <footer>Prototype ‚Äî demo only.</footer>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="assets/main.js"></script>
  <script>
    const chart = document.getElementById('chart');
    let autoRefreshInterval = null;
    
    // ===== SOCKET.IO LISTENERS =====
    if (window.socket) {
      socket.on('new_readings', (data) => {
        console.log('Real-time reading received:', data);
        updateChart();
        updateStats();
        AF.ToastNotification.info('üìä New reading received', 2000);
      });
      
      socket.on('settings_update', (settings) => {
        console.log('Settings updated from server:', settings);
        AF.ToastNotification.warning(`‚öôÔ∏è Thresholds updated: Warning=${settings.warning_temp}¬∞C, Alert=${settings.alert_temp}¬∞C`, 3000);
      });
    }
    
    // ===== STATS UPDATE =====
    function updateStats() {
      const data = AF.DataStore.load();
      if (!data || data.length === 0) {
        document.getElementById('stat-total').textContent = '--';
        document.getElementById('stat-avg').textContent = '--';
        document.getElementById('stat-peak').textContent = '--';
        document.getElementById('stat-count').textContent = '--';
        return;
      }
      
      const values = data.map(d => parseFloat(d.value) || 0);
      const total = values.reduce((a, b) => a + b, 0);
      const avg = total / values.length;
      const peak = Math.max(...values);
      
      document.getElementById('stat-total').textContent = total.toFixed(2);
      document.getElementById('stat-avg').textContent = avg.toFixed(2);
      document.getElementById('stat-peak').textContent = peak.toFixed(2);
      document.getElementById('stat-count').textContent = data.length;
      
      document.getElementById('summary').textContent = 
        `Total: ${total.toFixed(2)} | Average: ${avg.toFixed(2)} | Peak: ${peak.toFixed(2)} | Count: ${data.length}`;
    }
    
    // ===== CHART UPDATE =====
    function updateChart() {
      const filterType = document.getElementById('time-range').value;
      let data = AF.DataStore.load();
      
      if (filterType !== 'all' && data.length > 0) {
        const now = Date.now();
        const filterMs = {
          '24h': 24 * 3600 * 1000,
          '7d': 7 * 24 * 3600 * 1000,
          '30d': 30 * 24 * 3600 * 1000
        }[filterType];
        
        if (filterMs) {
          data = data.filter(d => (now - d.ts) < filterMs);
        }
      }
      
      if (data.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
        document.getElementById('chart-container').style.display = 'none';
      } else {
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('chart-container').style.display = 'block';
        AF.drawLineChart(chart, data);
      }
      
      updateStats();
    }
    
    // ===== TABLE UPDATE =====
    function updateTable() {
      const data = AF.DataStore.load();
      const tbody = document.getElementById('table-body');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; opacity: 0.6;">No data loaded</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.slice().reverse().slice(0, 50).map(d => `
        <tr>
          <td>${new Date(d.ts).toLocaleString()}</td>
          <td>${(d.value || 0).toFixed(2)}</td>
          <td>${(d.power || '--')}</td>
          <td>${(d.voltage || '--')}</td>
          <td>${(d.current || '--')}</td>
        </tr>
      `).join('');
    }
    
    // ===== BUTTON HANDLERS =====
    
    // Load/Refresh Data
    document.getElementById('btn-refresh').addEventListener('click', () => {
      const icon = document.getElementById('refresh-icon');
      icon.classList.add('spinning');
      setTimeout(() => {
        icon.classList.remove('spinning');
        updateChart();
        updateTable();
        AF.ToastNotification.success('Data refreshed');
      }, 600);
    });
    
    // Clear Data
    document.getElementById('btn-clear').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all data?')) {
        AF.DataStore.clear();
        updateChart();
        updateTable();
        AF.ToastNotification.info('Data cleared');
      }
    });
    
    // Download CSV
    document.getElementById('btn-download').addEventListener('click', () => {
      const data = AF.DataStore.load();
      AF.downloadCSV(data, `af-meter-${Date.now()}.csv`);
    });
    
    // Download JSON
    document.getElementById('btn-download-json').addEventListener('click', () => {
      const data = AF.DataStore.load();
      AF.downloadJSON(data, `af-meter-${Date.now()}.json`);
    });
    
    // Compare Periods (placeholder)
    document.getElementById('btn-compare').addEventListener('click', () => {
      AF.ToastNotification.warning('Compare Periods feature coming soon', 3000);
    });
    
    // Time range filter
    document.getElementById('time-range').addEventListener('change', (e) => {
      document.getElementById('custom-range').style.display = 
        e.target.value === 'custom' ? 'block' : 'none';
      updateChart();
    });
    
    // Apply custom date range
    document.getElementById('btn-apply-range').addEventListener('click', () => {
      const from = new Date(document.getElementById('date-from').value).getTime();
      const to = new Date(document.getElementById('date-to').value).getTime();
      
      if (!from || !to) {
        AF.ToastNotification.warning('Please select both dates');
        return;
      }
      
      const data = AF.DataStore.load().filter(d => d.ts >= from && d.ts <= to);
      document.getElementById('chart-container').style.display = data.length > 0 ? 'block' : 'none';
      AF.drawLineChart(chart, data);
      updateStats();
      AF.ToastNotification.success(`Applied filter: ${data.length} readings`);
    });
    
    // Auto-refresh checkbox
    document.getElementById('auto-refresh').addEventListener('change', (e) => {
      if (e.target.checked) {
        autoRefreshInterval = setInterval(() => {
          updateChart();
          updateTable();
        }, 30000);
        AF.ToastNotification.info('Auto-refresh enabled (30s)', 2000);
      } else {
        clearInterval(autoRefreshInterval);
        AF.ToastNotification.info('Auto-refresh disabled', 2000);
      }
    });
    
    // Chart type selector (placeholder for future)
    document.getElementById('chart-type').addEventListener('change', (e) => {
      AF.ToastNotification.info(`Chart type: ${e.target.value}`, 2000);
      // Future: render different chart types (bar, area, etc.)
    });
    
    // ===== INITIALIZE ON PAGE LOAD =====
    document.addEventListener('DOMContentLoaded', () => {
      updateChart();
      updateTable();
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    });
  </script>
</body>
</html>